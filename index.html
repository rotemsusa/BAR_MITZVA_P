<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>××™×©×•×¨ ×”×’×¢×” | ×‘×¨ ××¦×•×•×” ×©×œ ××•×¨×™</title>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #daeef8; --surface: #fff; --border: #b8d8ed;
      --text: #1a2f5e; --muted: #6b89a8;
      --accent: #1a3a8f; --accent-dark: #122a70; --accent-light: #a8d0e6;
      --pale: #eef6fb; --danger: #c0392b; --radius: 16px;
      --shadow: 0 8px 40px rgba(26,58,143,0.18);
    }
    body {
      font-family: 'Heebo', sans-serif; background-color: var(--bg);
      background-image: repeating-linear-gradient(45deg, rgba(26,58,143,0.04) 0, rgba(26,58,143,0.04) 1px, transparent 0, transparent 50%), repeating-linear-gradient(-45deg, rgba(26,58,143,0.04) 0, rgba(26,58,143,0.04) 1px, transparent 0, transparent 50%);
      background-size: 20px 20px; min-height: 100vh;
      display: flex; align-items: flex-start; justify-content: center;
      padding: 24px 16px; color: var(--text);
    }
    .card { background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow); width: 100%; max-width: 460px; overflow: hidden; border: 2px solid rgba(168,208,230,0.6); }

    /* HEADER */
    .header { background: linear-gradient(160deg, #1a3a8f 0%, #2255c4 60%, #1a4faa 100%); text-align: center; padding-bottom: 24px; position: relative; overflow: hidden; }
    .header-pattern { height: 48px; background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.07) 0, rgba(255,255,255,0.07) 2px, transparent 0, transparent 18px), repeating-linear-gradient(-45deg, rgba(255,255,255,0.07) 0, rgba(255,255,255,0.07) 2px, transparent 0, transparent 18px); border-bottom: 1px solid rgba(255,255,255,0.12); }
    .header-inner { padding: 16px 24px 0; }
    .star-of-david { font-size: 28px; display: block; color: var(--accent-light); margin-bottom: 8px; }
    .header-label { font-size: 12px; letter-spacing: 1px; color: rgba(168,208,230,0.85); margin-bottom: 4px; }
    .header-name { font-size: 52px; font-weight: 700; color: white; letter-spacing: 4px; text-shadow: 0 3px 12px rgba(0,0,0,0.25); line-height: 1; margin-bottom: 14px; }

    /* ×¤×¨×˜×™ ×”××™×¨×•×¢ */
    .event-details {
      background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15);
      border-radius: 12px; padding: 14px 16px; margin: 0 0 14px; text-align: right;
    }
    .event-main { font-size: 13px; color: rgba(255,255,255,0.9); line-height: 1.8; margin-bottom: 10px; }
    .event-main strong { color: var(--accent-light); }
    .sched-divider { height: 1px; background: rgba(255,255,255,0.12); margin: 8px 0; }
    .sched-row { display: flex; align-items: baseline; gap: 10px; margin-bottom: 5px; }
    .sched-time { font-size: 13px; font-weight: 700; color: var(--accent-light); min-width: 40px; flex-shrink: 0; }
    .sched-text { font-size: 13px; color: rgba(255,255,255,0.85); line-height: 1.4; }
    .sched-venue { font-size: 12px; color: rgba(168,208,230,0.7); margin-top: 2px; padding-right: 50px; }

    .header-family { font-size: 17px; font-weight: 600; color: rgba(255,255,255,0.9); margin-bottom: 4px; }

    /* Counter pills */
    .counter-pills { display: flex; gap: 8px; justify-content: center; margin-top: 12px; flex-wrap: wrap; }
    .counter-pill {
      display: inline-flex; align-items: center; gap: 8px;
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.22);
      border-radius: 100px; padding: 6px 16px; font-size: 13px; color: rgba(255,255,255,0.85); transition: opacity 0.3s;
    }
    .counter-pill.loading { opacity: 0.35; }
    .count-num { font-size: 20px; font-weight: 700; color: var(--accent-light); line-height: 1; }
    .count-label { font-size: 11px; }

    .header-pattern-bottom { height: 24px; margin-top: 18px; background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.07) 0, rgba(255,255,255,0.07) 2px, transparent 0, transparent 18px), repeating-linear-gradient(-45deg, rgba(255,255,255,0.07) 0, rgba(255,255,255,0.07) 2px, transparent 0, transparent 18px); border-top: 1px solid rgba(255,255,255,0.12); }

    /* BODY */
    .body { padding: 28px; background: white; }
    .screen { display: none; }
    .screen.active { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }

    /* PIN */
    .pin-label { font-size: 14px; color: var(--muted); text-align: center; margin-bottom: 20px; line-height: 1.7; }
    .pin-dots { display: flex; gap: 14px; justify-content: center; margin-bottom: 28px; }
    .pin-dot { width: 15px; height: 15px; border-radius: 50%; border: 2px solid var(--border); background: white; transition: all 0.2s; }
    .pin-dot.filled { background: var(--accent); border-color: var(--accent); }
    .pin-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 240px; margin: 0 auto; }
    .pin-btn { aspect-ratio: 1; border: 1.5px solid var(--border); border-radius: 12px; background: var(--pale); font-family: 'Heebo', sans-serif; font-size: 20px; font-weight: 500; cursor: pointer; transition: all 0.15s; color: var(--accent); }
    .pin-btn:hover  { background: #d6eaf8; border-color: var(--accent); }
    .pin-btn:active { transform: scale(0.93); background: var(--accent); color: white; }
    .pin-btn.zero   { grid-column: 2; }
    .pin-btn.del    { font-size: 16px; color: var(--muted); background: white; }
    .pin-error { text-align: center; color: var(--danger); font-size: 13px; margin-top: 16px; min-height: 20px; }

    /* Menu */
    .menu-btns { display: flex; flex-direction: column; gap: 12px; }
    .menu-btn { width: 100%; padding: 16px; border-radius: 12px; border: 1.5px solid var(--border); background: var(--pale); font-family: 'Heebo', sans-serif; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.2s; color: var(--text); display: flex; align-items: center; gap: 12px; }
    .menu-btn:hover { border-color: var(--accent); background: #d6eaf8; }
    .menu-btn .icon { font-size: 20px; }
    .menu-btn.primary { background: var(--accent); border-color: var(--accent); color: white; box-shadow: 0 4px 14px rgba(26,58,143,0.3); }
    .menu-btn.primary:hover { background: var(--accent-dark); }

    /* Fields */
    .field { margin-bottom: 18px; }
    label { display: block; font-size: 13px; font-weight: 600; color: var(--accent); margin-bottom: 6px; }
    input, textarea, select { width: 100%; border: 1.5px solid var(--border); border-radius: 10px; padding: 12px 14px; font-family: 'Heebo', sans-serif; font-size: 15px; color: var(--text); background: var(--pale); transition: all 0.2s; outline: none; }
    input:focus, textarea:focus, select:focus { border-color: var(--accent); background: white; box-shadow: 0 0 0 3px rgba(26,58,143,0.08); }
    input.error { border-color: var(--danger); }
    .guests-row { display: flex; align-items: center; gap: 16px; }
    .guests-row input { width: 80px; text-align: center; font-size: 24px; font-weight: 300; padding: 10px; background: white; }
    .counter-btn { width: 42px; height: 42px; border-radius: 50%; border: 1.5px solid var(--border); background: var(--pale); font-size: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; color: var(--accent); flex-shrink: 0; }
    .counter-btn:hover { border-color: var(--accent); background: #d6eaf8; }
    .divider { height: 1px; background: var(--border); margin: 20px 0; }

    /* Attendance type selector */
    .attend-options { display: flex; flex-direction: column; gap: 8px; }
    .attend-opt { display: flex; align-items: center; gap: 12px; padding: 12px 14px; border: 1.5px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.2s; background: var(--pale); }
    .attend-opt:hover { border-color: var(--accent); background: #d6eaf8; }
    .attend-opt input[type="radio"] { width: 18px; height: 18px; accent-color: var(--accent); flex-shrink: 0; cursor: pointer; }
    .attend-opt-label { font-size: 14px; font-weight: 500; color: var(--text); }
    .attend-opt-sub { font-size: 12px; color: var(--muted); margin-top: 1px; }
    .attend-opt.selected { border-color: var(--accent); background: #d6eaf8; }

    /* Buttons */
    .btn-primary { width: 100%; padding: 14px; border-radius: 10px; border: none; background: var(--accent); color: white; font-family: 'Heebo', sans-serif; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 14px rgba(26,58,143,0.3); }
    .btn-primary:hover    { background: var(--accent-dark); transform: translateY(-1px); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-secondary { width: 100%; padding: 12px; border-radius: 10px; border: 1.5px solid var(--border); background: white; font-family: 'Heebo', sans-serif; font-size: 14px; color: var(--muted); cursor: pointer; transition: all 0.2s; margin-top: 10px; }
    .btn-secondary:hover { border-color: var(--accent); color: var(--text); }
    .btn-danger { width: 100%; padding: 12px; border-radius: 10px; border: 1.5px solid #f5c6c6; background: #fdf0f0; font-family: 'Heebo', sans-serif; font-size: 14px; color: var(--danger); cursor: pointer; transition: all 0.2s; margin-top: 10px; }
    .btn-danger:hover { background: #fde0e0; }

    /* Search */
    .result-card { border: 1.5px solid var(--border); border-radius: 12px; padding: 14px 16px; margin-bottom: 10px; background: var(--pale); cursor: pointer; transition: all 0.2s; }
    .result-card:hover { border-color: var(--accent); background: #d6eaf8; }
    .result-name { font-size: 15px; font-weight: 600; color: var(--accent); margin-bottom: 3px; }
    .result-meta { font-size: 13px; color: var(--muted); }
    .no-results { text-align: center; color: var(--muted); font-size: 14px; padding: 24px 0; }

    .screen-header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
    .back-btn { width: 36px; height: 36px; border-radius: 50%; border: 1.5px solid var(--border); background: var(--pale); font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.15s; color: var(--accent); }
    .back-btn:hover { border-color: var(--accent); background: #d6eaf8; }
    .screen-title { font-size: 16px; font-weight: 600; color: var(--accent); }

    /* Success */
    .success-icon { width: 66px; height: 66px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), #3a6fd8); margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 4px 16px rgba(26,58,143,0.3); }
    .success-h   { font-size: 24px; font-weight: 700; text-align: center; color: var(--accent); margin-bottom: 8px; }
    .success-sub { font-size: 14px; color: var(--muted); text-align: center; line-height: 1.7; }
    .success-detail { margin-top: 20px; background: var(--pale); border-radius: 10px; padding: 14px 18px; font-size: 14px; line-height: 2.2; border: 1px solid var(--border); }
    .success-detail strong { color: var(--accent); }
    .success-totals { margin-top: 14px; background: var(--pale); border-radius: 10px; padding: 14px 18px; border: 1px solid var(--border); }
    .total-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 14px; }
    .total-row:last-child { border-bottom: none; }
    .total-label { color: var(--muted); }
    .total-num { font-size: 20px; font-weight: 700; color: var(--accent); }

    .error-banner { background: #fdf0f0; border: 1px solid #f5c6c6; border-radius: 8px; padding: 12px 16px; color: var(--danger); font-size: 13px; margin-bottom: 16px; display: none; }
    .error-banner.show { display: block; }

    .loading-overlay { position: fixed; inset: 0; background: rgba(218,238,248,0.8); display: none; align-items: center; justify-content: center; z-index: 999; }
    .loading-overlay.show { display: flex; }
    .spinner-large { width: 44px; height: 44px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; }
    .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.4); border-top-color: white; border-radius: 50%; animation: spin 0.7s linear infinite; vertical-align: middle; margin-right: 6px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Stats box in menu */
    .menu-stats { display: flex; gap: 10px; margin-bottom: 16px; }
    .stat-box { flex: 1; background: var(--pale); border: 1.5px solid var(--border); border-radius: 12px; padding: 12px; text-align: center; }
    .stat-num { font-size: 32px; font-weight: 700; color: var(--accent); line-height: 1; }
    .stat-label { font-size: 12px; color: var(--muted); margin-top: 4px; }
  </style>
</head>
<body>

<div class="loading-overlay" id="loading"><div class="spinner-large"></div></div>

<div class="card">
  <div class="header">
    <div class="header-pattern"></div>
    <div class="header-inner">
      <span class="star-of-david">âœ¡</span>
      <div class="header-label">×©××—×™× ×•× ×¨×’×©×™× ×œ×”×–××™× ×›× ×œ×‘×¨-××¦×•×•×” ×©×œ ×‘× × ×•</div>
      <div class="header-name">××•×¨×™</div>

      <div class="event-details">
        <div class="event-main">
          ×”××™×¨×•×¢ ×™×ª×§×™×™× ×‘×™×•× ×—××™×©×™ <strong>×›×´×˜ × ×™×¡×Ÿ ×”×³×ª×©×¤×´×• Â· 16/04/2026</strong><br>
          ×‘×‘×™×ª ×”×›× ×¡×ª <strong>"××•×”×œ ×¨×—×œ"</strong> ×‘×™×ª ×”×‘×“×•×œ×— 10, ××•×“×™×¢×™×Ÿ
        </div>
        <div class="sched-row"><span class="sched-time">09:30</span><span class="sched-text">×§×‘×œ×ª ×¤× ×™×, ×§×¤×” ×•×¢×•×’×”</span></div>
        <div class="sched-row"><span class="sched-time">10:00</span><span class="sched-text">×ª×¤×™×œ×” ××•×–×™×§×œ×™×ª ×‘×œ×™×•×•×™ ×”×¤×™×™×˜×Ÿ × ×ª×Ÿ ×©×•×”×</span></div>
        <div class="sched-divider"></div>
        <div class="sched-row"><span class="sched-time">12:30</span><span class="sched-text">××•×œ××™ ×”××—×•×–×” ××•×“×™×¢×™×Ÿ</span></div>
        <div class="sched-venue">×©×“×¨×•×ª ×”×ª×¢×©×™×™×” 14, ××•×“×™×¢×™×Ÿ</div>
      </div>

      <div class="header-family">××©×¤×—×ª ×©××¢×•× ×•×‘×™×¥</div>

      <div class="counter-pills">
        <div class="counter-pill loading" id="pill-prayer">
          <span class="count-num" id="count-prayer">â€”</span>
          <div><div class="count-label">×œ×ª×¤×™×œ×”</div></div>
        </div>
        <div class="counter-pill loading" id="pill-lunch">
          <span class="count-num" id="count-lunch">â€”</span>
          <div><div class="count-label">×œ×¦×”×¨×™×™×</div></div>
        </div>
      </div>
    </div>
    <div class="header-pattern-bottom"></div>
  </div>

  <div class="body">

    <!-- â‘  PIN -->
    <div class="screen active" id="screen-pin">
      <p class="pin-label">×”×–×™× ×• ××ª ×§×•×“ ×”×’×™×©×”<br>×©×§×™×‘×œ×ª× ×××ª ×”××©×¤×—×”</p>
      <div class="pin-dots">
        <div class="pin-dot" id="dot-0"></div><div class="pin-dot" id="dot-1"></div>
        <div class="pin-dot" id="dot-2"></div><div class="pin-dot" id="dot-3"></div>
      </div>
      <div class="pin-pad">
        <button class="pin-btn" onclick="pinPress('1')">1</button>
        <button class="pin-btn" onclick="pinPress('2')">2</button>
        <button class="pin-btn" onclick="pinPress('3')">3</button>
        <button class="pin-btn" onclick="pinPress('4')">4</button>
        <button class="pin-btn" onclick="pinPress('5')">5</button>
        <button class="pin-btn" onclick="pinPress('6')">6</button>
        <button class="pin-btn" onclick="pinPress('7')">7</button>
        <button class="pin-btn" onclick="pinPress('8')">8</button>
        <button class="pin-btn" onclick="pinPress('9')">9</button>
        <button class="pin-btn zero" onclick="pinPress('0')">0</button>
        <button class="pin-btn del"  onclick="pinDelete()">âŒ«</button>
      </div>
      <div class="pin-error" id="pin-error"></div>
    </div>

    <!-- â‘¡ Menu -->
    <div class="screen" id="screen-menu">
      <div class="menu-stats">
        <div class="stat-box"><div class="stat-num" id="menu-count-prayer">â€”</div><div class="stat-label">ğŸ™ ××’×™×¢×™× ×œ×ª×¤×™×œ×”</div></div>
        <div class="stat-box"><div class="stat-num" id="menu-count-lunch">â€”</div><div class="stat-label">ğŸ½ï¸ ××’×™×¢×™× ×œ×¦×”×¨×™×™×</div></div>
      </div>
      <div class="menu-btns">
        <button class="menu-btn primary" onclick="showScreen('screen-form')">
          <span class="icon">âœ…</span><span>××™×©×•×¨ ×”×’×¢×” ×—×“×©</span>
        </button>
        <button class="menu-btn" onclick="showScreen('screen-search')">
          <span class="icon">âœï¸</span><span>×¢×“×›×•×Ÿ / ×‘×™×˜×•×œ ×”×’×¢×” ×§×™×™××ª</span>
        </button>
      </div>
    </div>

    <!-- â‘¢ Form -->
    <div class="screen" id="screen-form">
      <div class="screen-header">
        <button class="back-btn" onclick="showScreen('screen-menu')">â†’</button>
        <div class="screen-title">××™×©×•×¨ ×”×’×¢×” ×—×“×©</div>
      </div>
      <div class="error-banner" id="form-error"></div>
      <div class="field"><label>×©× ××œ× *</label><input type="text" id="name" placeholder="×™×©×¨××œ ×™×©×¨××œ×™" /></div>
      <div class="field"><label>×˜×œ×¤×•×Ÿ (××•×¤×¦×™×•× ×œ×™)</label><input type="tel" id="phone" placeholder="050-0000000" /></div>
      <input type="hidden" id="date" value="2026-04-16" />
      <div class="divider"></div>
      <div class="field">
        <label>××’×™×¢ ×œ... *</label>
        <div class="attend-options">
          <label class="attend-opt" id="opt-both">
            <input type="radio" name="attendance" value="both" checked onchange="selectAttend(this.closest('label'))" />
            <div>
              <div class="attend-opt-label">ğŸ™ğŸ½ï¸ ×œ×ª×¤×™×œ×” ×•×œ×¦×”×¨×™×™×</div>
              <div class="attend-opt-sub">09:30 ×ª×¤×™×œ×” + 12:30 ××•×œ××™ ×”××—×•×–×”</div>
            </div>
          </label>
          <label class="attend-opt" id="opt-lunch">
            <input type="radio" name="attendance" value="lunch" onchange="selectAttend(this.closest('label'))" />
            <div>
              <div class="attend-opt-label">ğŸ½ï¸ ×¨×§ ×œ×¦×”×¨×™×™×</div>
              <div class="attend-opt-sub">12:30 ××•×œ××™ ×”××—×•×–×” ×‘×œ×‘×“</div>
            </div>
          </label>
        </div>
      </div>
      <div class="divider"></div>
      <div class="field">
        <label>×›××” ×× ×©×™× ××’×™×¢×™×?</label>
        <div class="guests-row">
          <button class="counter-btn" onclick="changeGuests('guests',-1)">âˆ’</button>
          <input type="number" id="guests" value="1" min="1" max="20" readonly />
          <button class="counter-btn" onclick="changeGuests('guests',1)">+</button>
        </div>
      </div>
      <div class="field"><label>×©××•×ª ×”××’×™×¢×™×</label><textarea id="names" rows="3" placeholder="×™×©×¨××œ, ×©×¨×”, ×™×•×¡×™..."></textarea></div>
      <div class="field"><label>×”×¢×¨×•×ª</label><textarea id="notes" rows="2" placeholder="××œ×¨×’×™×•×ª, ×‘×§×©×•×ª ××™×•×—×“×•×ª..."></textarea></div>
      <button class="btn-primary" id="save-btn" onclick="saveRSVP()">×©××•×¨ ××™×©×•×¨ ×”×’×¢×”</button>
      <button class="btn-secondary" onclick="showScreen('screen-menu')">×‘×™×˜×•×œ</button>
    </div>

    <!-- â‘£ Search -->
    <div class="screen" id="screen-search">
      <div class="screen-header">
        <button class="back-btn" onclick="showScreen('screen-menu')">â†’</button>
        <div class="screen-title">×—×™×¤×•×© ×¨×™×©×•× ×§×™×™×</div>
      </div>
      <div class="field">
        <label>×—×¤×© ×œ×¤×™ ×©×</label>
        <input type="text" id="search-input" placeholder="×”×–×Ÿ ×©×..." oninput="searchRSVP()" />
      </div>
      <div id="search-results"></div>
    </div>

    <!-- â‘¤ Edit -->
    <div class="screen" id="screen-edit">
      <div class="screen-header">
        <button class="back-btn" onclick="showScreen('screen-search')">â†’</button>
        <div class="screen-title">×¢×¨×™×›×ª ×¨×™×©×•×</div>
      </div>
      <div class="error-banner" id="edit-error"></div>
      <input type="hidden" id="edit-row-id" />
      <div class="field"><label>×©× ××œ× *</label><input type="text" id="edit-name" /></div>
      <div class="field"><label>×˜×œ×¤×•×Ÿ</label><input type="tel" id="edit-phone" /></div>
      <input type="hidden" id="edit-date" value="2026-04-16" />
      <div class="divider"></div>
      <div class="field">
        <label>××’×™×¢ ×œ...</label>
        <div class="attend-options">
          <label class="attend-opt" id="edit-opt-both">
            <input type="radio" name="edit-attendance" value="both" onchange="selectAttend(this.closest('label'))" />
            <div>
              <div class="attend-opt-label">ğŸ™ğŸ½ï¸ ×œ×ª×¤×™×œ×” ×•×œ×¦×”×¨×™×™×</div>
            </div>
          </label>
          <label class="attend-opt" id="edit-opt-lunch">
            <input type="radio" name="edit-attendance" value="lunch" onchange="selectAttend(this.closest('label'))" />
            <div>
              <div class="attend-opt-label">ğŸ½ï¸ ×¨×§ ×œ×¦×”×¨×™×™×</div>
            </div>
          </label>
        </div>
      </div>
      <div class="divider"></div>
      <div class="field">
        <label>×›××” ×× ×©×™× ××’×™×¢×™×?</label>
        <div class="guests-row">
          <button class="counter-btn" onclick="changeGuests('edit-guests',-1)">âˆ’</button>
          <input type="number" id="edit-guests" value="1" min="1" max="20" readonly />
          <button class="counter-btn" onclick="changeGuests('edit-guests',1)">+</button>
        </div>
      </div>
      <div class="field"><label>×©××•×ª ×”××’×™×¢×™×</label><textarea id="edit-names" rows="3"></textarea></div>
      <div class="field"><label>×”×¢×¨×•×ª</label><textarea id="edit-notes" rows="2"></textarea></div>
      <button class="btn-primary" id="update-btn" onclick="updateRSVP()">×©××•×¨ ×©×™× ×•×™×™×</button>
      <button class="btn-danger" onclick="confirmDelete()">ğŸ—‘ï¸ ××—×§ ×¨×™×©×•× ×–×”</button>
      <button class="btn-secondary" onclick="showScreen('screen-search')">×‘×™×˜×•×œ</button>
    </div>

    <!-- â‘¥ Success -->
    <div class="screen" id="screen-success">
      <div class="success-icon" id="s-icon">âœ“</div>
      <div class="success-h"   id="s-title">×ª×•×“×” ×¨×‘×”!</div>
      <p class="success-sub"  id="s-sub"></p>
      <div class="success-detail" id="s-detail"></div>
      <div class="success-totals" id="s-totals"></div>
      <button class="btn-secondary" style="margin-top:20px" onclick="goHome()">×—×–×¨×” ×œ×ª×¤×¨×™×˜</button>
    </div>

  </div>
</div>

<script>
  const API_URL = 'https://bar-mitzva-246561042500.me-west1.run.app/api';

  let accessCode = '', pinValue = '';

  function showScreen(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); if (id === 'screen-menu') loadCounter(); }
  function showLoading(on) { document.getElementById('loading').classList.toggle('show', on); }
  function setErr(id, msg) { const el=document.getElementById(id); el.textContent=msg; el.classList.toggle('show',!!msg); }

  // ×‘×—×™×¨×ª ××¤×©×¨×•×ª ×”×’×¢×” â€” ××¡××Ÿ visually
  function selectAttend(el) {
    const group = el.closest('.attend-options');
    group.querySelectorAll('.attend-opt').forEach(o=>o.classList.remove('selected'));
    el.classList.add('selected');
  }
  // ×¡××Ÿ ×‘×¨×™×¨×ª ××—×“×œ ×‘×˜×¢×™× ×”
  document.querySelector('#opt-both').classList.add('selected');

  function getAttendance(name) {
    const sel = document.querySelector(`input[name="${name}"]:checked`);
    return sel ? sel.value : 'both';
  }

  async function loadCounter() {
    try {
      const res = await fetch(API_URL + '/count');
      const data = await res.json();
      ['prayer','lunch'].forEach(k => {
        const menuEl = document.getElementById('menu-count-'+k);
        if (menuEl) menuEl.textContent = data[k] ?? 'â€”';
        document.getElementById('pill-'+k).classList.remove('loading');
        document.getElementById('count-'+k).textContent = data[k] ?? 'â€”';
      });
    } catch {
      document.getElementById('count-prayer').textContent = 'â€”';
      document.getElementById('count-lunch').textContent = 'â€”';
    }
  }

  function pinPress(digit) { if(pinValue.length>=4) return; pinValue+=digit; updateDots(); if(pinValue.length===4) checkPin(); }
  function pinDelete() { pinValue=pinValue.slice(0,-1); updateDots(); document.getElementById('pin-error').textContent=''; }
  function updateDots() { for(let i=0;i<4;i++) document.getElementById('dot-'+i).classList.toggle('filled',i<pinValue.length); }

  async function checkPin() {
    showLoading(true);
    try {
      const res=await fetch(API_URL+'/verify',{method:'POST',headers:{'Content-Type':'application/json','X-API-Key':pinValue}});
      const data=await res.json();
      if(data.success){accessCode=pinValue;showScreen('screen-menu');}
      else{document.getElementById('pin-error').textContent='×§×•×“ ×©×’×•×™, × ×¡×• ×©×•×‘';setTimeout(()=>{pinValue='';updateDots();document.getElementById('pin-error').textContent='';},1000);}
    }catch{document.getElementById('pin-error').textContent='×©×’×™××ª ×—×™×‘×•×¨, × ×¡×• ×©×•×‘';setTimeout(()=>{pinValue='';updateDots();document.getElementById('pin-error').textContent='';},1500);}
    finally{showLoading(false);}
  }

  function changeGuests(id,delta){const el=document.getElementById(id);const v=parseInt(el.value)+delta;if(v>=1&&v<=20)el.value=v;}

  async function saveRSVP() {
    const name=document.getElementById('name').value.trim(), phone=document.getElementById('phone').value.trim(),
          date=document.getElementById('date').value, guests=document.getElementById('guests').value,
          names=document.getElementById('names').value.trim(), notes=document.getElementById('notes').value.trim(),
          attendance=getAttendance('attendance');
    setErr('form-error','');
    if(!name){setErr('form-error','× × ×œ×”×–×™×Ÿ ×©× ××œ×');document.getElementById('name').classList.add('error');setTimeout(()=>document.getElementById('name').classList.remove('error'),2000);return;}
    const btn=document.getElementById('save-btn');btn.disabled=true;btn.innerHTML='<span class="spinner"></span>×©×•××¨...';
    showLoading(true);
    try {
      const res=await fetch(API_URL+'/rsvp',{method:'POST',headers:{'Content-Type':'application/json','X-API-Key':accessCode},
        body:JSON.stringify({action:'create',timestamp:new Date().toLocaleString('he-IL'),name,phone,date,guests,names,notes,attendance})});
      const data=await res.json();if(!data.success)throw new Error(data.error);
      await loadCounter();
      showSuccess('âœ“','×ª×•×“×” ×¨×‘×”!','×”××™×©×•×¨ × ×©××¨ â€” × ×©××— ×œ×¨××•×ª×›×! ğŸ‰',name,guests,names,notes,attendance,data.counts);
      ['name','phone','names','notes'].forEach(id=>document.getElementById(id).value='');
      document.getElementById('guests').value=1;
      document.querySelector('input[name="attendance"][value="both"]').checked=true;
      document.querySelectorAll('#opt-both,#opt-lunch').forEach(o=>o.classList.remove('selected'));
      document.getElementById('opt-both').classList.add('selected');
    }catch{setErr('form-error','×©×’×™××” ×‘×©××™×¨×” â€” × ×¡×• ×©×•×‘');}
    finally{btn.disabled=false;btn.innerHTML='×©××•×¨ ××™×©×•×¨ ×”×’×¢×”';showLoading(false);}
  }

  let searchTimer;
  function searchRSVP(){
    clearTimeout(searchTimer);
    const q=document.getElementById('search-input').value.trim(),box=document.getElementById('search-results');
    if(!q){box.innerHTML='';return;}
    searchTimer=setTimeout(async()=>{
      showLoading(true);
      try{const res=await fetch(API_URL+'/rsvp?action=search&q='+encodeURIComponent(q),{headers:{'X-API-Key':accessCode}});const data=await res.json();renderResults(data.results||[]);}
      catch{box.innerHTML='<div class="no-results">×©×’×™××” ×‘×—×™×¤×•×©</div>';}
      finally{showLoading(false);}
    },400);
  }

  const attendLabel = v => v==='both'?'×ª×¤×™×œ×” ×•×¦×”×¨×™×™×':'×¨×§ ×¦×”×¨×™×™×';

  function renderResults(results){
    const box=document.getElementById('search-results');
    if(!results.length){box.innerHTML='<div class="no-results">×œ× × ××¦××• ×ª×•×¦××•×ª</div>';return;}
    box.innerHTML=results.map(r=>`<div class="result-card" onclick='openEdit(${JSON.stringify(r)})'><div class="result-name">${r.name}</div><div class="result-meta">${r.guests} ××’×™×¢×™× Â· ${attendLabel(r.attendance)}${r.names?' Â· '+r.names:''}</div></div>`).join('');
  }

  function openEdit(r){
    document.getElementById('edit-row-id').value=r.rowId;
    document.getElementById('edit-name').value=r.name||'';
    document.getElementById('edit-phone').value=r.phone||'';
    document.getElementById('edit-guests').value=r.guests||1;
    document.getElementById('edit-names').value=r.names||'';
    document.getElementById('edit-notes').value=r.notes||'';
    const att=r.attendance||'both';
    document.querySelector(`input[name="edit-attendance"][value="${att}"]`).checked=true;
    document.querySelectorAll('#edit-opt-both,#edit-opt-lunch').forEach(o=>o.classList.remove('selected'));
    document.getElementById(att==='both'?'edit-opt-both':'edit-opt-lunch').classList.add('selected');
    setErr('edit-error','');showScreen('screen-edit');
  }

  async function updateRSVP(){
    const rowId=document.getElementById('edit-row-id').value, name=document.getElementById('edit-name').value.trim(),
          phone=document.getElementById('edit-phone').value.trim(), date=document.getElementById('edit-date').value,
          guests=document.getElementById('edit-guests').value, names=document.getElementById('edit-names').value.trim(),
          notes=document.getElementById('edit-notes').value.trim(), attendance=getAttendance('edit-attendance');
    if(!name){setErr('edit-error','× × ×œ×”×–×™×Ÿ ×©× ××œ×');return;}
    const btn=document.getElementById('update-btn');btn.disabled=true;btn.innerHTML='<span class="spinner"></span>×©×•××¨...';
    showLoading(true);
    try{
      const res=await fetch(API_URL+'/rsvp',{method:'POST',headers:{'Content-Type':'application/json','X-API-Key':accessCode},
        body:JSON.stringify({action:'update',rowId,name,phone,date,guests,names,notes,attendance})});
      const data=await res.json();if(!data.success)throw new Error(data.error);
      await loadCounter();showSuccess('âœ“','×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!','âœï¸ ×”×¨×™×©×•× ×¢×•×“×›×Ÿ.',name,guests,names,notes,attendance,data.counts);
    }catch{setErr('edit-error','×©×’×™××” ×‘×¢×“×›×•×Ÿ â€” × ×¡×• ×©×•×‘');}
    finally{btn.disabled=false;btn.innerHTML='×©××•×¨ ×©×™× ×•×™×™×';showLoading(false);}
  }

  function confirmDelete(){if(confirm('×œ××—×•×§ ××ª ×”×¨×™×©×•× ×œ×—×œ×•×˜×™×Ÿ?'))deleteRSVP();}

  async function deleteRSVP(){
    const rowId=document.getElementById('edit-row-id').value, name=document.getElementById('edit-name').value.trim();
    showLoading(true);
    try{
      const res=await fetch(API_URL+'/rsvp',{method:'POST',headers:{'Content-Type':'application/json','X-API-Key':accessCode},body:JSON.stringify({action:'delete',rowId})});
      const data=await res.json();if(!data.success)throw new Error(data.error);
      await loadCounter();
      document.getElementById('s-icon').textContent='ğŸ—‘ï¸';document.getElementById('s-title').textContent='×”×¨×™×©×•× × ××—×§';
      document.getElementById('s-sub').textContent=`×”×¨×™×©×•× ×©×œ ${name} ×”×•×¡×¨ ××”×¨×©×™××”`;
      document.getElementById('s-detail').innerHTML='';
      document.getElementById('s-totals').innerHTML=renderTotals(data.counts);
      showScreen('screen-success');
    }catch{alert('×©×’×™××” ×‘××—×™×§×” â€” × ×¡×• ×©×•×‘');}
    finally{showLoading(false);}
  }

  function renderTotals(counts){
    if(!counts) return '';
    return `<div class="total-row"><span class="total-label">ğŸ™ ××’×™×¢×™× ×œ×ª×¤×™×œ×”</span><span class="total-num">${counts.prayer}</span></div>
            <div class="total-row"><span class="total-label">ğŸ½ï¸ ××’×™×¢×™× ×œ×¦×”×¨×™×™×</span><span class="total-num">${counts.lunch}</span></div>`;
  }

  function showSuccess(icon,title,sub,name,guests,names,notes,attendance,counts){
    document.getElementById('s-icon').textContent=icon;
    document.getElementById('s-title').textContent=title;
    document.getElementById('s-sub').innerHTML=sub;
    document.getElementById('s-detail').innerHTML=
      `<strong>×©×:</strong> ${name}<br>` +
      `<strong>××¡×¤×¨ ××’×™×¢×™×:</strong> ${guests}<br>` +
      `<strong>×”×’×¢×”:</strong> ${attendLabel(attendance)}<br>` +
      (names?`<strong>×©××•×ª:</strong> ${names}<br>`:'') +
      (notes?`<strong>×”×¢×¨×•×ª:</strong> ${notes}`:'');
    document.getElementById('s-totals').innerHTML=renderTotals(counts);
    showScreen('screen-success');
  }

  function goHome(){document.getElementById('search-input').value='';document.getElementById('search-results').innerHTML='';showScreen('screen-menu');}

  loadCounter();
</script>
</body>
</html>
