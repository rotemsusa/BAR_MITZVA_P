<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>××™×©×•×¨ ×”×’×¢×” | ×‘×¨ ××¦×•×•×” ×©×œ ××•×¨×™</title>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #f9f8f6; --surface: #fff; --border: #e8e4de;
      --text: #1a1a1a; --muted: #888;
      --accent: #c8a96e; --accent-dark: #b8954d;
      --danger: #e74c3c; --radius: 12px;
      --shadow: 0 2px 24px rgba(0,0,0,0.07);
    }
    body {
      font-family: 'Heebo', sans-serif; background: var(--bg);
      min-height: 100vh; display: flex;
      align-items: flex-start; justify-content: center;
      padding: 24px 16px; color: var(--text);
    }
    .card { background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow); width: 100%; max-width: 460px; overflow: hidden; }

    /* Header */
    .header { background: linear-gradient(135deg, #1a1a1a, #2d2d2d); color: white; text-align: center; padding: 36px 32px 28px; }
    .star { font-size: 26px; margin-bottom: 10px; opacity: 0.85; }
    .header h1 { font-size: 11px; font-weight: 400; letter-spacing: 3px; text-transform: uppercase; color: var(--accent); margin-bottom: 6px; }
    .header h2 { font-size: 30px; font-weight: 300; letter-spacing: 1px; }
    .header h2 strong { font-weight: 600; }
    .counter-pill {
      display: inline-flex; align-items: center; gap: 10px;
      margin-top: 16px; background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.15); border-radius: 100px;
      padding: 8px 22px; font-size: 14px; color: rgba(255,255,255,0.8);
      transition: opacity 0.3s;
    }
    .counter-pill.loading { opacity: 0.4; }
    .count-num { font-size: 24px; font-weight: 600; color: var(--accent); line-height: 1; }

    .body { padding: 28px; }
    .screen { display: none; }
    .screen.active { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }

    /* PIN */
    .pin-label { font-size: 14px; color: var(--muted); text-align: center; margin-bottom: 20px; line-height: 1.6; }
    .pin-dots { display: flex; gap: 12px; justify-content: center; margin-bottom: 28px; }
    .pin-dot { width: 14px; height: 14px; border-radius: 50%; border: 2px solid var(--border); background: white; transition: all 0.2s; }
    .pin-dot.filled { background: var(--accent); border-color: var(--accent); }
    .pin-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 240px; margin: 0 auto; }
    .pin-btn { aspect-ratio:1; border: 1.5px solid var(--border); border-radius: 10px; background: white; font-family: 'Heebo', sans-serif; font-size: 20px; cursor: pointer; transition: all 0.15s; color: var(--text); }
    .pin-btn:hover  { background: var(--bg); border-color: var(--accent); }
    .pin-btn:active { transform: scale(0.95); }
    .pin-btn.zero   { grid-column: 2; }
    .pin-btn.del    { font-size: 16px; color: var(--muted); }
    .pin-error { text-align: center; color: var(--danger); font-size: 13px; margin-top: 16px; min-height: 20px; }

    /* Menu */
    .menu-btns { display: flex; flex-direction: column; gap: 12px; }
    .menu-btn {
      width: 100%; padding: 16px; border-radius: 10px;
      border: 1.5px solid var(--border); background: white;
      font-family: 'Heebo', sans-serif; font-size: 15px; font-weight: 500;
      cursor: pointer; transition: all 0.2s; color: var(--text);
      display: flex; align-items: center; gap: 12px;
    }
    .menu-btn:hover { border-color: var(--accent); background: #fdf9f4; }
    .menu-btn .icon { font-size: 20px; }
    .menu-btn.primary { background: var(--accent); border-color: var(--accent); color: white; }
    .menu-btn.primary:hover { background: var(--accent-dark); border-color: var(--accent-dark); }

    /* Form fields */
    .field { margin-bottom: 20px; }
    label { display: block; font-size: 13px; font-weight: 500; color: var(--muted); margin-bottom: 6px; letter-spacing: 0.5px; }
    input, textarea {
      width: 100%; border: 1.5px solid var(--border); border-radius: 8px;
      padding: 12px 14px; font-family: 'Heebo', sans-serif; font-size: 15px;
      color: var(--text); background: white; transition: border-color 0.2s; outline: none;
    }
    input:focus, textarea:focus { border-color: var(--accent); }
    input.error { border-color: var(--danger); }
    .guests-row { display: flex; align-items: center; gap: 16px; }
    .guests-row input { width: 80px; text-align: center; font-size: 22px; font-weight: 300; padding: 10px; }
    .counter-btn {
      width: 40px; height: 40px; border-radius: 50%;
      border: 1.5px solid var(--border); background: white;
      font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.15s; color: var(--text); flex-shrink: 0;
    }
    .counter-btn:hover { border-color: var(--accent); color: var(--accent); }
    .divider { height: 1px; background: var(--border); margin: 20px 0; }

    /* Buttons */
    .btn-primary {
      width: 100%; padding: 14px; border-radius: 8px; border: none;
      background: var(--accent); color: white;
      font-family: 'Heebo', sans-serif; font-size: 15px; font-weight: 500;
      cursor: pointer; transition: all 0.2s;
    }
    .btn-primary:hover    { background: var(--accent-dark); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary {
      width: 100%; padding: 12px; border-radius: 8px;
      border: 1.5px solid var(--border); background: white;
      font-family: 'Heebo', sans-serif; font-size: 14px; color: var(--muted);
      cursor: pointer; transition: all 0.2s; margin-top: 10px;
    }
    .btn-secondary:hover { border-color: var(--accent); color: var(--text); }
    .btn-danger {
      width: 100%; padding: 12px; border-radius: 8px;
      border: 1.5px solid #ffd0d0; background: #fff0f0;
      font-family: 'Heebo', sans-serif; font-size: 14px; color: var(--danger);
      cursor: pointer; transition: all 0.2s; margin-top: 10px;
    }
    .btn-danger:hover { background: #ffe4e4; }

    /* Search */
    .result-card {
      border: 1.5px solid var(--border); border-radius: 10px;
      padding: 14px 16px; margin-bottom: 10px; background: #fafaf8;
      cursor: pointer; transition: all 0.2s;
    }
    .result-card:hover { border-color: var(--accent); background: #fdf9f4; }
    .result-name  { font-size: 15px; font-weight: 500; margin-bottom: 3px; }
    .result-meta  { font-size: 13px; color: var(--muted); }
    .no-results   { text-align: center; color: var(--muted); font-size: 14px; padding: 24px 0; }

    /* Screen header (back btn + title) */
    .screen-header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
    .back-btn {
      width: 36px; height: 36px; border-radius: 50%;
      border: 1.5px solid var(--border); background: white;
      font-size: 16px; cursor: pointer; display: flex;
      align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.15s;
    }
    .back-btn:hover { border-color: var(--accent); }
    .screen-title { font-size: 16px; font-weight: 500; }

    /* Success */
    .success-icon {
      width: 62px; height: 62px; border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; font-size: 26px;
    }
    .success-h    { font-size: 22px; font-weight: 500; text-align: center; margin-bottom: 8px; }
    .success-sub  { font-size: 14px; color: var(--muted); text-align: center; line-height: 1.7; }
    .success-detail { margin-top: 20px; background: var(--bg); border-radius: 8px; padding: 14px 18px; font-size: 14px; line-height: 2; }
    .success-total { margin-top: 14px; text-align: center; font-size: 15px; color: var(--muted); }
    .success-total strong { color: var(--accent); font-size: 22px; }

    /* Error banner */
    .error-banner {
      background: #fff0f0; border: 1px solid #ffcccc;
      border-radius: 8px; padding: 12px 16px;
      color: var(--danger); font-size: 13px; margin-bottom: 16px; display: none;
    }
    .error-banner.show { display: block; }

    /* Loading */
    .loading-overlay {
      position: fixed; inset: 0; background: rgba(255,255,255,0.75);
      display: none; align-items: center; justify-content: center; z-index: 999;
    }
    .loading-overlay.show { display: flex; }
    .spinner-large { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; }
    .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.4); border-top-color: white; border-radius: 50%; animation: spin 0.7s linear infinite; vertical-align: middle; margin-right: 6px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div class="loading-overlay" id="loading"><div class="spinner-large"></div></div>

<div class="card">
  <div class="header">
    <div class="star">âœ¡</div>
    <h1>××™×©×•×¨ ×”×’×¢×”</h1>
    <h2>×‘×¨ ××¦×•×•×” ×©×œ <strong>××•×¨×™</strong></h2>
    <div class="counter-pill loading" id="counter-pill">
      <span class="count-num" id="total-count">â€”</span>
      <span>××’×™×¢×™× ××™×©×¨×• ×”×’×¢×”</span>
    </div>
  </div>

  <div class="body">

    <!-- â‘  PIN -->
    <div class="screen active" id="screen-pin">
      <p class="pin-label">×”×–×™× ×• ××ª ×§×•×“ ×”×’×™×©×”<br>×©×§×™×‘×œ×ª× ×××ª ×”××©×¤×—×”</p>
      <div class="pin-dots">
        <div class="pin-dot" id="dot-0"></div><div class="pin-dot" id="dot-1"></div>
        <div class="pin-dot" id="dot-2"></div><div class="pin-dot" id="dot-3"></div>
      </div>
      <div class="pin-pad">
        <button class="pin-btn" onclick="pinPress('1')">1</button>
        <button class="pin-btn" onclick="pinPress('2')">2</button>
        <button class="pin-btn" onclick="pinPress('3')">3</button>
        <button class="pin-btn" onclick="pinPress('4')">4</button>
        <button class="pin-btn" onclick="pinPress('5')">5</button>
        <button class="pin-btn" onclick="pinPress('6')">6</button>
        <button class="pin-btn" onclick="pinPress('7')">7</button>
        <button class="pin-btn" onclick="pinPress('8')">8</button>
        <button class="pin-btn" onclick="pinPress('9')">9</button>
        <button class="pin-btn zero" onclick="pinPress('0')">0</button>
        <button class="pin-btn del"  onclick="pinDelete()">âŒ«</button>
      </div>
      <div class="pin-error" id="pin-error"></div>
    </div>

    <!-- â‘¡ Menu -->
    <div class="screen" id="screen-menu">
      <div class="menu-btns">
        <button class="menu-btn primary" onclick="showScreen('screen-form')">
          <span class="icon">âœ…</span><span>××™×©×•×¨ ×”×’×¢×” ×—×“×©</span>
        </button>
        <button class="menu-btn" onclick="showScreen('screen-search')">
          <span class="icon">âœï¸</span><span>×¢×“×›×•×Ÿ / ×‘×™×˜×•×œ ×”×’×¢×” ×§×™×™××ª</span>
        </button>
      </div>
    </div>

    <!-- â‘¢ Form â€” new RSVP -->
    <div class="screen" id="screen-form">
      <div class="screen-header">
        <button class="back-btn" onclick="showScreen('screen-menu')">â†’</button>
        <div class="screen-title">××™×©×•×¨ ×”×’×¢×” ×—×“×©</div>
      </div>
      <div class="error-banner" id="form-error"></div>
      <div class="field"><label>×©× ××œ× *</label><input type="text" id="name" placeholder="×™×©×¨××œ ×™×©×¨××œ×™" /></div>
      <div class="field"><label>×˜×œ×¤×•×Ÿ (××•×¤×¦×™×•× ×œ×™)</label><input type="tel" id="phone" placeholder="050-0000000" /></div>
      <div class="field"><label>×ª××¨×™×š ×”×’×¢×”</label><input type="date" id="date" /></div>
      <div class="divider"></div>
      <div class="field">
        <label>×›××” ×× ×©×™× ××’×™×¢×™×?</label>
        <div class="guests-row">
          <button class="counter-btn" onclick="changeGuests('guests',-1)">âˆ’</button>
          <input type="number" id="guests" value="1" min="1" max="20" readonly />
          <button class="counter-btn" onclick="changeGuests('guests',1)">+</button>
        </div>
      </div>
      <div class="field"><label>×©××•×ª ×”××’×™×¢×™×</label><textarea id="names" rows="3" placeholder="×™×©×¨××œ, ×©×¨×”, ×™×•×¡×™..."></textarea></div>
      <div class="field"><label>×”×¢×¨×•×ª</label><textarea id="notes" rows="2" placeholder="××œ×¨×’×™×•×ª, ×‘×§×©×•×ª ××™×•×—×“×•×ª..."></textarea></div>
      <button class="btn-primary" id="save-btn" onclick="saveRSVP()">×©××•×¨ ××™×©×•×¨ ×”×’×¢×”</button>
      <button class="btn-secondary" onclick="showScreen('screen-menu')">×‘×™×˜×•×œ</button>
    </div>

    <!-- â‘£ Search -->
    <div class="screen" id="screen-search">
      <div class="screen-header">
        <button class="back-btn" onclick="showScreen('screen-menu')">â†’</button>
        <div class="screen-title">×—×™×¤×•×© ×¨×™×©×•× ×§×™×™×</div>
      </div>
      <div class="field">
        <label>×—×¤×© ×œ×¤×™ ×©×</label>
        <input type="text" id="search-input" placeholder="×”×–×Ÿ ×©×..." oninput="searchRSVP()" />
      </div>
      <div id="search-results"></div>
    </div>

    <!-- â‘¤ Edit -->
    <div class="screen" id="screen-edit">
      <div class="screen-header">
        <button class="back-btn" onclick="showScreen('screen-search')">â†’</button>
        <div class="screen-title">×¢×¨×™×›×ª ×¨×™×©×•×</div>
      </div>
      <div class="error-banner" id="edit-error"></div>
      <input type="hidden" id="edit-row-id" />
      <div class="field"><label>×©× ××œ× *</label><input type="text" id="edit-name" /></div>
      <div class="field"><label>×˜×œ×¤×•×Ÿ</label><input type="tel" id="edit-phone" /></div>
      <div class="field"><label>×ª××¨×™×š ×”×’×¢×”</label><input type="date" id="edit-date" /></div>
      <div class="divider"></div>
      <div class="field">
        <label>×›××” ×× ×©×™× ××’×™×¢×™×?</label>
        <div class="guests-row">
          <button class="counter-btn" onclick="changeGuests('edit-guests',-1)">âˆ’</button>
          <input type="number" id="edit-guests" value="1" min="1" max="20" readonly />
          <button class="counter-btn" onclick="changeGuests('edit-guests',1)">+</button>
        </div>
      </div>
      <div class="field"><label>×©××•×ª ×”××’×™×¢×™×</label><textarea id="edit-names" rows="3"></textarea></div>
      <div class="field"><label>×”×¢×¨×•×ª</label><textarea id="edit-notes" rows="2"></textarea></div>
      <button class="btn-primary" id="update-btn" onclick="updateRSVP()">×©××•×¨ ×©×™× ×•×™×™×</button>
      <button class="btn-danger" onclick="confirmDelete()">ğŸ—‘ï¸ ××—×§ ×¨×™×©×•× ×–×”</button>
      <button class="btn-secondary" onclick="showScreen('screen-search')">×‘×™×˜×•×œ</button>
    </div>

    <!-- â‘¥ Success -->
    <div class="screen" id="screen-success">
      <div class="success-icon" id="s-icon">âœ“</div>
      <div class="success-h"    id="s-title">×ª×•×“×” ×¨×‘×”!</div>
      <p class="success-sub"   id="s-sub"></p>
      <div class="success-detail" id="s-detail"></div>
      <div class="success-total"  id="s-total"></div>
      <button class="btn-secondary" style="margin-top:20px" onclick="goHome()">×—×–×¨×” ×œ×ª×¤×¨×™×˜</button>
    </div>

  </div>
</div>

<script>
  // ============================================================
  // ×”×’×“×¨×” ×™×—×™×“×” â€” ×”×—×œ×£ ×‘-Cloud Run URL ×©×œ×š
  // ============================================================
  const API_URL = 'https://bar-mitzva-246561042500.me-west1.run.app/api';
  // ============================================================

  let accessCode = '';
  let pinValue   = '';

  /* ---------- Utils ---------- */
  function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }
  function showLoading(on) { document.getElementById('loading').classList.toggle('show', on); }
  function setErr(id, msg) {
    const el = document.getElementById(id);
    el.textContent = msg;
    el.classList.toggle('show', !!msg);
  }

  /* ---------- Counter (public, no auth) ---------- */
  async function loadCounter() {
    try {
      const res  = await fetch(API_URL + '/count');
      const data = await res.json();
      document.getElementById('counter-pill').classList.remove('loading');
      document.getElementById('total-count').textContent = data.total ?? 'â€”';
    } catch {
      document.getElementById('total-count').textContent = 'â€”';
    }
  }

  /* ---------- PIN ---------- */
  function pinPress(digit) {
    if (pinValue.length >= 4) return;
    pinValue += digit;
    updateDots();
    if (pinValue.length === 4) checkPin();
  }
  function pinDelete() {
    pinValue = pinValue.slice(0, -1);
    updateDots();
    document.getElementById('pin-error').textContent = '';
  }
  function updateDots() {
    for (let i = 0; i < 4; i++)
      document.getElementById('dot-' + i).classList.toggle('filled', i < pinValue.length);
  }
  async function checkPin() {
    showLoading(true);
    try {
      const res  = await fetch(API_URL + '/verify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-API-Key': pinValue }
      });
      const data = await res.json();
      if (data.success) {
        accessCode = pinValue;
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
        showScreen('screen-menu');
      } else {
        document.getElementById('pin-error').textContent = '×§×•×“ ×©×’×•×™, × ×¡×• ×©×•×‘';
        setTimeout(() => { pinValue = ''; updateDots(); document.getElementById('pin-error').textContent = ''; }, 1000);
      }
    } catch {
      document.getElementById('pin-error').textContent = '×©×’×™××ª ×—×™×‘×•×¨, × ×¡×• ×©×•×‘';
      setTimeout(() => { pinValue = ''; updateDots(); document.getElementById('pin-error').textContent = ''; }, 1500);
    } finally { showLoading(false); }
  }

  /* ---------- Guest counter ---------- */
  function changeGuests(id, delta) {
    const el  = document.getElementById(id);
    const val = parseInt(el.value) + delta;
    if (val >= 1 && val <= 20) el.value = val;
  }

  /* ---------- Save new RSVP ---------- */
  async function saveRSVP() {
    const name   = document.getElementById('name').value.trim();
    const phone  = document.getElementById('phone').value.trim();
    const date   = document.getElementById('date').value;
    const guests = document.getElementById('guests').value;
    const names  = document.getElementById('names').value.trim();
    const notes  = document.getElementById('notes').value.trim();

    setErr('form-error', '');
    if (!name) {
      setErr('form-error', '× × ×œ×”×–×™×Ÿ ×©× ××œ×');
      document.getElementById('name').classList.add('error');
      setTimeout(() => document.getElementById('name').classList.remove('error'), 2000);
      return;
    }

    const btn = document.getElementById('save-btn');
    btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>×©×•××¨...';
    showLoading(true);
    try {
      const res  = await fetch(API_URL + '/rsvp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-API-Key': accessCode },
        body: JSON.stringify({ action:'create', timestamp: new Date().toLocaleString('he-IL'), name, phone, date, guests, names, notes })
      });
      const data = await res.json();
      if (!data.success) throw new Error(data.error);
      await loadCounter();
      showSuccess('âœ“', '×ª×•×“×” ×¨×‘×”!', '×”××™×©×•×¨ × ×©××¨ â€” × ×©××— ×œ×¨××•×ª×›×! ğŸ‰', name, date, guests, names, notes, data.total);
      ['name','phone','names','notes'].forEach(id => document.getElementById(id).value = '');
      document.getElementById('guests').value = 1;
    } catch {
      setErr('form-error', '×©×’×™××” ×‘×©××™×¨×” â€” × ×¡×• ×©×•×‘');
    } finally {
      btn.disabled = false; btn.innerHTML = '×©××•×¨ ××™×©×•×¨ ×”×’×¢×”';
      showLoading(false);
    }
  }

  /* ---------- Search ---------- */
  let searchTimer;
  function searchRSVP() {
    clearTimeout(searchTimer);
    const q   = document.getElementById('search-input').value.trim();
    const box = document.getElementById('search-results');
    if (!q) { box.innerHTML = ''; return; }
    searchTimer = setTimeout(async () => {
      showLoading(true);
      try {
        const res  = await fetch(API_URL + '/rsvp?action=search&q=' + encodeURIComponent(q), {
          headers: { 'X-API-Key': accessCode }
        });
        const data = await res.json();
        renderResults(data.results || []);
      } catch { box.innerHTML = '<div class="no-results">×©×’×™××” ×‘×—×™×¤×•×©</div>'; }
      finally { showLoading(false); }
    }, 400);
  }

  function renderResults(results) {
    const box = document.getElementById('search-results');
    if (!results.length) { box.innerHTML = '<div class="no-results">×œ× × ××¦××• ×ª×•×¦××•×ª</div>'; return; }
    box.innerHTML = results.map(r => `
      <div class="result-card" onclick='openEdit(${JSON.stringify(r)})'>
        <div class="result-name">${r.name}</div>
        <div class="result-meta">${r.guests} ××’×™×¢×™× Â· ${r.date || '×œ×œ× ×ª××¨×™×š'}${r.names ? ' Â· ' + r.names : ''}</div>
      </div>`).join('');
  }

  /* ---------- Edit ---------- */
  function openEdit(r) {
    document.getElementById('edit-row-id').value = r.rowId;
    document.getElementById('edit-name').value   = r.name   || '';
    document.getElementById('edit-phone').value  = r.phone  || '';
    document.getElementById('edit-date').value   = r.date   || '';
    document.getElementById('edit-guests').value = r.guests || 1;
    document.getElementById('edit-names').value  = r.names  || '';
    document.getElementById('edit-notes').value  = r.notes  || '';
    setErr('edit-error', '');
    showScreen('screen-edit');
  }

  async function updateRSVP() {
    const rowId  = document.getElementById('edit-row-id').value;
    const name   = document.getElementById('edit-name').value.trim();
    const phone  = document.getElementById('edit-phone').value.trim();
    const date   = document.getElementById('edit-date').value;
    const guests = document.getElementById('edit-guests').value;
    const names  = document.getElementById('edit-names').value.trim();
    const notes  = document.getElementById('edit-notes').value.trim();

    if (!name) { setErr('edit-error', '× × ×œ×”×–×™×Ÿ ×©× ××œ×'); return; }

    const btn = document.getElementById('update-btn');
    btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>×©×•××¨...';
    showLoading(true);
    try {
      const res  = await fetch(API_URL + '/rsvp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-API-Key': accessCode },
        body: JSON.stringify({ action:'update', rowId, name, phone, date, guests, names, notes })
      });
      const data = await res.json();
      if (!data.success) throw new Error(data.error);
      await loadCounter();
      showSuccess('âœ“', '×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!', 'âœï¸ ×”×¨×™×©×•× ×¢×•×“×›×Ÿ.', name, date, guests, names, notes, data.total);
    } catch {
      setErr('edit-error', '×©×’×™××” ×‘×¢×“×›×•×Ÿ â€” × ×¡×• ×©×•×‘');
    } finally {
      btn.disabled = false; btn.innerHTML = '×©××•×¨ ×©×™× ×•×™×™×';
      showLoading(false);
    }
  }

  /* ---------- Delete ---------- */
  function confirmDelete() { if (confirm('×œ××—×•×§ ××ª ×”×¨×™×©×•× ×œ×—×œ×•×˜×™×Ÿ?')) deleteRSVP(); }

  async function deleteRSVP() {
    const rowId = document.getElementById('edit-row-id').value;
    const name  = document.getElementById('edit-name').value.trim();
    showLoading(true);
    try {
      const res  = await fetch(API_URL + '/rsvp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-API-Key': accessCode },
        body: JSON.stringify({ action:'delete', rowId })
      });
      const data = await res.json();
      if (!data.success) throw new Error(data.error);
      await loadCounter();
      document.getElementById('s-icon').textContent  = 'ğŸ—‘ï¸';
      document.getElementById('s-title').textContent = '×”×¨×™×©×•× × ××—×§';
      document.getElementById('s-sub').textContent   = `×”×¨×™×©×•× ×©×œ ${name} ×”×•×¡×¨ ××”×¨×©×™××”`;
      document.getElementById('s-detail').innerHTML  = '';
      document.getElementById('s-total').innerHTML   = `×¡×”"×› ×›×¢×ª: <strong>${data.total}</strong> ××’×™×¢×™×`;
      showScreen('screen-success');
    } catch { alert('×©×’×™××” ×‘××—×™×§×” â€” × ×¡×• ×©×•×‘'); }
    finally { showLoading(false); }
  }

  /* ---------- Success helper ---------- */
  function showSuccess(icon, title, sub, name, date, guests, names, notes, total) {
    document.getElementById('s-icon').textContent  = icon;
    document.getElementById('s-title').textContent = title;
    document.getElementById('s-sub').innerHTML     = sub;
    document.getElementById('s-detail').innerHTML  = `
      <strong>×©×:</strong> ${name}<br>
      ${date  ? `<strong>×ª××¨×™×š:</strong> ${new Date(date+'T12:00:00').toLocaleDateString('he-IL')}<br>` : ''}
      <strong>××¡×¤×¨ ××’×™×¢×™×:</strong> ${guests}<br>
      ${names ? `<strong>×©××•×ª:</strong> ${names}<br>` : ''}
      ${notes ? `<strong>×”×¢×¨×•×ª:</strong> ${notes}` : ''}
    `;
    document.getElementById('s-total').innerHTML =
      total !== undefined ? `×¡×”"×› ×××•×©×¨×™× ×›×¢×ª: <strong>${total}</strong> ğŸŠ` : '';
    showScreen('screen-success');
  }

  function goHome() {
    document.getElementById('search-input').value    = '';
    document.getElementById('search-results').innerHTML = '';
    showScreen('screen-menu');
  }

  // Load counter on page open â€” ×¦×™×‘×•×¨×™, ×œ×¤× ×™ PIN
  loadCounter();
</script>
</body>
</html>
